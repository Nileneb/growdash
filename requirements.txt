# Vereinfachte Dependencies fÃ¼r Hardware-Agent
fastapi==0.104.1






































































































































































































































































































































































**Letzte Aktualisierung**: 2025-12-02**Next**: Laravel-Backend gemÃ¤ÃŸ Anleitung umsetzen  **Status**: âœ… Python vollstÃ¤ndig implementiert  ---- [ ] Cron-Job fÃ¼r Offline-Marking (optional)- [ ] Middleware registriert (`device.auth`)- [ ] Route registriert (`POST /api/growdash/agent/heartbeat`)- [ ] `AuthenticateDevice` Middleware erstellt- [ ] `AgentController::heartbeat()` implementiert- [ ] Migration: `last_state` (JSON) Spalte in `devices`### Laravel (Backend)- [x] Heartbeat-Thread in `run()` gestartet- [x] `HardwareAgent.heartbeat_loop()` implementiert- [x] `LaravelClient.send_heartbeat()` implementiert- [x] `psutil` in `requirements.txt`### Python (Agent)## âœ… Checkliste---```* * * * * cd /path-to-laravel && php artisan schedule:run >> /dev/null 2>&1```cron**Cron (Production)**:```Schedule::command('devices:mark-offline')->everyMinute();use Illuminate\Support\Facades\Schedule;```php**Scheduler** (`routes/console.php`):```}    }        $this->info("Marked {$count} devices as offline");                    ->update(['status' => 'offline']);            ->where('status', 'online')        $count = Device::where('last_seen_at', '<', now()->subMinutes(2))    {    public function handle()    protected $description = 'Mark devices as offline if no heartbeat in 2 minutes';    protected $signature = 'devices:mark-offline';{class MarkOfflineDevices extends Commanduse App\Models\Device;use Illuminate\Console\Command;namespace App\Console\Commands;<?php```php**Command**: `app/Console/Commands/MarkOfflineDevices.php`### Automatisches Offline-Marking (Cron)## ðŸ“Š Status-Logik (Backend)---- Laravel-Logs prÃ¼fen: `tail -f storage/logs/laravel.log`- PrÃ¼fe `AgentController::heartbeat()` enthÃ¤lt `'status' => 'online'`**LÃ¶sung**:**Ursache**: Controller aktualisiert Status nicht  ### Problem: Heartbeat sendet, aber Device bleibt "offline"```# Sollte zeigen: POST api/growdash/agent/heartbeatphp artisan route:list | grep heartbeat```bash**LÃ¶sung**:**Ursache**: Route nicht definiert  ### Problem: 404 Not Found  ```  hash('sha256', 'token-aus-env') === $device->agent_token  ```php- Token in Laravel-DB mit SHA256-Hash vergleichen:- PrÃ¼fe `.env`: `DEVICE_PUBLIC_ID` und `DEVICE_TOKEN` vorhanden?**LÃ¶sung**:**Ursache**: Device-Token ungÃ¼ltig  ### Problem: 401 Unauthorized## ðŸ” Troubleshooting---```>>> $device->last_state; // Sollte uptime, memory, etc. enthalten>>> $device->status; // Sollte 'online' sein>>> $device->last_seen_at; // Sollte < 1 Minute alt sein>>> $device = Device::where('public_id', 'deine-device-id')->first();php artisan tinker```bash4. Laravel-Datenbank prÃ¼fen:```...âœ… Heartbeat gesendet (uptime: 60s)âœ… Heartbeat gesendet (uptime: 30s)  Heartbeat: alle 30s  Befehle: alle 5s  Telemetrie: alle 10sAgent lÃ¤uft...```3. Logs prÃ¼fen:```./grow_start.sh```bash2. Starte Agent:```# â†’ Direct Login durchfÃ¼hren./setup.sh```bash1. Registriere Device:### Python Agent Test```}  "last_seen_at": "2025-12-02T12:34:56.000000Z"  "message": "Heartbeat received",  "success": true,{```json**Erwartete Antwort (200)**:```  }'    }      "platform": "linux"      "memory_percent": 45.2,      "uptime": 3600,    "last_state": {  -d '{  -H "Content-Type: application/json" \  -H "X-Device-Token: $AGENT_TOKEN" \  -H "X-Device-ID: $DEVICE_ID" \curl -X POST https://grow.linn.games/api/growdash/agent/heartbeat \AGENT_TOKEN="abc123...xyz"DEVICE_ID="9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d"# Nach erfolgreicher Device-Registrierung:```bash### Manual cURL Test## ðŸ§ª Testing---```});    }        $table->json('last_state')->nullable()->after('device_info');    if (!Schema::hasColumn('devices', 'last_state')) {Schema::table('devices', function (Blueprint $table) {```php### 4. Migration (falls noch nicht vorhanden)```});    Route::post('/commands/{id}/result', [AgentController::class, 'commandResult']);    Route::get('/commands/pending', [AgentController::class, 'pendingCommands']);    Route::post('/telemetry', [AgentController::class, 'telemetry']);    Route::post('/heartbeat', [AgentController::class, 'heartbeat']);Route::middleware('device.auth')->prefix('growdash/agent')->group(function () {use App\Http\Controllers\Api\AgentController;```php**Datei**: `routes/api.php`### 3. Route```})    ]);        'device.auth' => \App\Http\Middleware\AuthenticateDevice::class,    $middleware->alias([->withMiddleware(function (Middleware $middleware) {```php**Registrierung in** `bootstrap/app.php`:```}    }        return $next($request);                $request->merge(['device' => $device]);        // Device an Request anhÃ¤ngen                }            return response()->json(['error' => 'Invalid credentials'], 401);        if (!$device || !hash_equals($device->agent_token, hash('sha256', $token))) {                $device = Device::where('public_id', $deviceId)->first();                }            return response()->json(['error' => 'Missing credentials'], 401);        if (!$deviceId || !$token) {                $token = $request->header('X-Device-Token');        $deviceId = $request->header('X-Device-ID');    {    public function handle(Request $request, Closure $next){class AuthenticateDeviceuse App\Models\Device;use Illuminate\Http\Request;use Closure;namespace App\Http\Middleware;<?php```php**Datei**: `app/Http/Middleware/AuthenticateDevice.php`### 2. Middleware```}    }        ]);            'last_seen_at' => $device->last_seen_at,            'message' => 'Heartbeat received',            'success' => true,        return response()->json([                Log::info("Heartbeat from device {$device->public_id}");                }            ]);                'last_state' => $request->last_state,            $device->update([        if ($request->has('last_state')) {        // Optional: last_state speichern                ]);            'status' => 'online',            'last_seen_at' => now(),        $device->update([        // last_seen_at + status aktualisieren                $device = $request->device;        // Device kommt von AuthenticateDevice Middleware    {    public function heartbeat(Request $request){class AgentController extends Controlleruse Illuminate\Support\Facades\Log;use Illuminate\Http\Request;use App\Http\Controllers\Controller;namespace App\Http\Controllers\Api;<?php```php**Datei**: `app/Http/Controllers/Api/AgentController.php`### 1. Controller## ðŸ”§ Laravel-Backend (Implementierung erforderlich)---```        return False        logger.error(f"Heartbeat-Fehler: {e}")    except Exception as e:                return response.status_code == 200                )            timeout=5            json=payload if payload else None,            f"{self.base_url}/agent/heartbeat",        response = self.session.post(                    payload["last_state"] = last_state        if last_state:        payload = {}    try:    """Heartbeat senden"""def send_heartbeat(self, last_state: Optional[Dict] = None) -> bool:```python### LaravelClient.send_heartbeat()```            time.sleep(30)            logger.error(f"Fehler in Heartbeat-Loop: {e}")        except Exception as e:                        time.sleep(30)                            logger.debug(f"âœ… Heartbeat gesendet (uptime: {uptime}s)")            if success:                        success = self.laravel.send_heartbeat(last_state)            # Heartbeat senden                        }                "platform": platform.system().lower(),                "python_version": platform.python_version(),                "memory_percent": memory.percent,                "memory_used": memory.used,                "uptime": uptime,            last_state = {                        memory = psutil.virtual_memory()            uptime = int(time.time() - start_time)            # System-Status sammeln        try:    while not self._stop_event.is_set():        start_time = time.time()        import psutil    import platform    """Sendet alle 30 Sekunden Heartbeat"""def heartbeat_loop(self):```python### Heartbeat-Loop## âœ… Python-Implementierung (bereits in agent.py)---- Optional System-Status zu Ã¼bermitteln (Uptime, Memory, etc.)- `last_seen_at` zu aktualisieren- Device-Status auf `online` zu haltenDer Agent sendet **alle 30 Sekunden** einen Heartbeat an das Laravel-Backend, um:## ðŸŽ¯ Ãœbersichtuvicorn==0.24.0
pyserial==3.5
requests==2.31.0
python-dotenv==1.0.0
pydantic==2.5.0
pydantic-settings==2.1.0
psutil==5.9.6

# Optional fÃ¼r Kamera (falls benÃ¶tigt)
opencv-python==4.8.1.78
