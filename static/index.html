<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arduino & Webcam Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0b1220; color: #e2e8f0; }
    .card { background: #0f172a; border-radius: 1rem; padding: 1rem; box-shadow: 0 0 0 1px rgba(148,163,184,.08) inset; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { padding: .5rem .8rem; border-radius: .75rem; background: #1e293b; }
    .btn:hover { background: #334155; }
    .btn-ok { background: #16a34a; } .btn-ok:hover { background: #22c55e; }
    .btn-bad { background: #dc2626; } .btn-bad:hover { background: #ef4444; }
    .btn-act { background: #2563eb; } .btn-act:hover { background: #3b82f6; }
    input { color: #111; }
    /* Wasserstand-Anzeige-Stile */
    .water-level-container {
      height: 24px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 5px;
    }
    .water-level-bar {
      height: 100%;
      background: #3b82f6;
      transition: width 0.5s ease;
      border-radius: 12px;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .control-group {
      padding: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-bottom: 12px;
    }
  </style>
  <script src="/static/water.js"></script>
</head>
<body>
  <div class="max-w-[1400px] mx-auto p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="text-xl font-semibold">Arduino &amp; Webcam Dashboard</div>
      <div id="port" class="text-xs opacity-70">Port: …</div>
    </div>

    <!-- Layout: 12 Spalten -->
    <div class="grid grid-cols-12 gap-4">
      <!-- Arduino Steuerung -->
      <div class="card col-span-4">
        <div class="font-semibold mb-2">Arduino Steuerung</div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <input id="command" type="text" placeholder="Befehl eingeben..." class="w-full rounded-md px-2 py-1">
          </div>
          <div class="flex items-center gap-2">
            <button id="btnSend" class="btn btn-ok">Senden</button>
            <button id="btnStatus" class="btn btn-act">Status</button>
          </div>
        </div>
      </div>
      
      <!-- Wassersteuerung -->
      <div class="card col-span-4">
        <div class="font-semibold mb-3">Wassersteuerung</div>
        
        <!-- Wasserstand -->
        <div class="mb-4">
          <div class="flex justify-between items-center">
            <div>Wasserstand:</div>
            <div id="waterLevelText">0%</div>
          </div>
          <div class="water-level-container">
            <div id="waterLevelBar" class="water-level-bar" style="width: 0%"></div>
          </div>
        </div>
        
        <!-- Sprühnebel-Steuerung -->
        <div class="control-group">
          <div class="flex items-center mb-2">
            <div class="status-indicator bg-gray-300" id="sprayActiveIndicator"></div>
            <div class="font-semibold">Sprühnebel</div>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <input type="number" id="sprayDuration" min="0" max="3600" placeholder="Sekunden" 
                   class="w-24 text-sm rounded-md px-2 py-1" title="Sprühdauer in Sekunden (0 = dauerhaft)">
            <span class="text-sm">Sekunden</span>
          </div>
          <button id="sprayToggleButton" class="btn btn-ok">Spray einschalten</button>
        </div>
        
        <!-- Wasserzufuhr-Steuerung -->
        <div class="control-group">
          <div class="flex items-center mb-2">
            <div class="status-indicator bg-gray-300" id="fillActiveIndicator"></div>
            <div class="font-semibold">Wasserzufuhr</div>
          </div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="flex flex-col">
              <label class="text-xs mb-1">Ziel-Füllstand</label>
              <input type="number" id="fillTarget" min="0" max="100" placeholder="%" 
                     class="w-full text-sm rounded-md px-2 py-1">
            </div>
            <div class="flex flex-col">
              <label class="text-xs mb-1">Dauer (Sekunden)</label>
              <input type="number" id="fillDuration" min="0" max="3600" placeholder="Sek" 
                     class="w-full text-sm rounded-md px-2 py-1">
            </div>
          </div>
          <div class="flex gap-2">
            <button id="fillStartButton" class="btn btn-ok flex-1">Start</button>
            <button id="fillStopButton" class="btn btn-bad flex-1" disabled>Stop</button>
          </div>
        </div>
      </div>

      <!-- Kamera -->
      <div class="card col-span-8">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Kamera</div>
          <a class="text-xs underline" href="/snapshot.jpg" target="_blank">Snapshot</a>
        </div>
        <div class="flex gap-4 mt-3">
          <img id="cam" class="rounded-lg" style="width: 480px; height: 320px; object-fit: cover;" alt="camera">
          <div class="flex flex-col gap-2">
            <button id="btnAudioOn" class="btn btn-ok">Audio ON</button>
            <button id="btnAudioOff" class="btn btn-bad">Audio OFF</button>
            <div class="mt-4">
              <div id="audioStatus" class="text-xs opacity-70">Audio Status: Nicht aktiv</div>
              <audio id="audioStream" controls style="display: none;"></audio>
            </div>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="card col-span-12">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Log</div>
          <button id="btnLogClear" class="btn text-sm">Clear</button>
        </div>
        <pre id="log" class="mono mt-2 text-[12px]" style="height: 220px; overflow: auto; white-space: pre-wrap;"></pre>
      </div>
    </div>
  </div>

<script>
const H = {"Content-Type": "application/json"};

function appendLog(t) {
  const e = document.getElementById('log');
  const atBottom = (e.scrollTop + e.clientHeight + 4) >= e.scrollHeight;
  e.textContent += (e.textContent ? "\n" : "") + t;
  if (e.textContent.length > 80000) e.textContent = e.textContent.slice(-80000);
  if (atBottom) e.scrollTop = e.scrollHeight;
}
// Globale Verfügbarkeit für water.js
window.appendLog = appendLog;

async function api(p, opts = {}) {
  const r = await fetch(p, {headers: H, ...opts});
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  window.ws = new WebSocket(`${proto}://${location.host}/ws`);
  window.ws.onopen = () => appendLog('[ws] connected');
  window.ws.onclose = () => {appendLog('[ws] closed'); setTimeout(connectWS, 1200);};
  window.ws.onerror = () => appendLog('[ws] error');
  window.ws.onmessage = e => {
    try {
      const m = JSON.parse(e.data);
      
      // Wassersteuerungs-Nachrichten behandeln
      if (window.waterControls && window.waterControls.handleSocketMessage && window.waterControls.handleSocketMessage(m)) {
        return;
      }
      
      // Standard-Nachrichtentypen
      if (m.type === 'log') {
        appendLog(m.data);
        
        // Log-Zeilen auf Wasserinformationen prüfen
        if (m.data && typeof m.data === 'string') {
          if (m.data.includes('WaterLevel:')) {
            const match = m.data.match(/WaterLevel:\s*(\d+)/);
            if (match && match[1]) {
              const level = parseInt(match[1], 10);
              if (window.waterControls && !isNaN(level)) {
                window.updateWaterLevel(level);
              }
            }
          }
          
          if (m.data.includes('Spray:')) {
            const isActive = m.data.includes('Spray: ON');
            if (window.waterControls) {
              window.updateSprayStatus(isActive);
            }
          }
          
          if (m.data.includes('Filling:')) {
            const isActive = m.data.includes('Filling: ON');
            if (window.waterControls) {
              window.updateFillStatus(isActive);
            }
          }
        }
      }
      else if (m.type === 'audio_status') {
        document.getElementById('audioStatus').textContent = 
          `Audio Status: ${m.enabled ? 'Aktiv (' + m.sample_rate + ' Hz)' : 'Nicht aktiv'}`;
      }
      else if (m.type === 'water_status') {
        // Direktes Wasser-Status-Update
        if ('water_level' in m && window.updateWaterLevel) {
          window.updateWaterLevel(m.water_level);
        }
        if ('spray_active' in m && window.updateSprayStatus) {
          window.updateSprayStatus(m.spray_active);
        }
        if ('filling_active' in m && window.updateFillStatus) {
          window.updateFillStatus(m.filling_active);
        }
      }
    } catch (err) {
      console.error('Fehler bei der Verarbeitung einer WebSocket-Nachricht:', err);
    }
  };
  
  // Globale Funktionen für Wassersteuerung verfügbar machen
  window.updateWaterLevel = function(level) {
    if (window.waterControls && window.waterControls.updateWaterLevel) {
      window.waterControls.updateWaterLevel(level);
    }
  }
  
  window.updateSprayStatus = function(active) {
    if (window.waterControls && window.waterControls.updateSprayStatus) {
      window.waterControls.updateSprayStatus(active);
    }
  }
  
  window.updateFillStatus = function(active) {
    if (window.waterControls && window.waterControls.updateFillStatus) {
      window.waterControls.updateFillStatus(active);
    }
  }
}

// Kamera: MJPEG mit Snapshot-Fallback
function startCamera() {
  const img = document.getElementById('cam');
  let usingSnap = false;
  let snapTimer = null;

  function startSnapshot() {
    if (usingSnap) return;
    usingSnap = true;
    const tick = () => {
      img.src = '/snapshot.jpg?r=' + Date.now();
      snapTimer = setTimeout(tick, 3000); // alle 3s
    };
    tick();
  }

  function startMjpeg() {
    usingSnap = false;
    if (snapTimer) { clearTimeout(snapTimer); snapTimer = null; }
    img.onerror = startSnapshot;
    img.src = '/video.mjpg?r=' + Date.now();
  }

  // Stream zuerst probieren; Klick auf das Bild versucht jederzeit wieder MJPEG
  startMjpeg();
  img.addEventListener('click', startMjpeg);
}

// Audio-Stream starten
function startAudio() {
  const audio = document.getElementById('audioStream');
  audio.src = '/audio.wav?r=' + Date.now();
  audio.style.display = 'block';
  audio.play().catch(e => appendLog(`Audio-Fehler: ${e.message}`));
}

// Audio-Stream stoppen
function stopAudio() {
  const audio = document.getElementById('audioStream');
  audio.pause();
  audio.style.display = 'none';
}

async function init() {
  connectWS(); 
  startCamera();
  
  // Wassersteuerung initialisieren
  if (window.waterControls && window.waterControls.init) {
    window.waterControls.init();
  }
  
  try {
    const p = await api('/api/ports');
    document.getElementById('port').textContent = `Port: ${p.current || '—'}`;
  } catch (_) {}

  // Arduino-Kommandos
  document.getElementById('btnSend').onclick = async () => {
    const cmd = document.getElementById('command').value.trim();
    if (!cmd) return;
    try {
      appendLog(`[Versuch] Sende Befehl: ${cmd}`);
      const response = await fetch('/api/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command: cmd})
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API-Fehler: ${response.status} ${errorText}`);
      }
      
      const result = await response.json();
      if (result.success) {
        appendLog(`[Gesendet] ${cmd}`);
      } else {
        appendLog(`[Fehler] ${result.error || 'Unbekannter Fehler'}`);
      }
    } catch (e) {
      appendLog(`[Fehler] ${e.message}`);
    }
  };
  
  // Status-Button
  document.getElementById('btnStatus').onclick = async () => {
    try {
      appendLog(`[Versuch] Sende Status-Befehl`);
      const response = await fetch('/api/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command: "Status"})
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API-Fehler: ${response.status} ${errorText}`);
      }
      
      const result = await response.json();
      if (result.success) {
        appendLog('[Gesendet] Status');
      } else {
        appendLog(`[Fehler] ${result.error || 'Unbekannter Fehler'}`);
      }
    } catch (e) {
      appendLog(`[Fehler] ${e.message}`);
    }
  };

  // Audio-Buttons
  document.getElementById('btnAudioOn').onclick = startAudio;
  document.getElementById('btnAudioOff').onclick = stopAudio;
  
  // Log-Button
  document.getElementById('btnLogClear').onclick = () => {
    document.getElementById('log').textContent = '';
  };
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
